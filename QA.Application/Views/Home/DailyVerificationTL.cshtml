@{
    ViewData["Title"] = "Daily Verification - Tech Lead";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid mt-4 px-3 px-md-4">
    <h3 class="mb-4 text-primary fw-bold">
        <i class="fas fa-user-check me-2"></i>Daily Verification - Tech Lead Review
    </h3>

    <!-- Filters -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h6>
        </div>
        <div class="card-body">
            <form id="tlFilterForm" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">From Date *</label>
                    <input type="date" class="form-control" id="tlFromDate" required />
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">To Date *</label>
                    <input type="date" class="form-control" id="tlToDate" required />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Load Pending
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- TL Review Table -->
    <div class="card shadow border-0" id="tlCard" style="display:none;">
        <div class="card-header bg-light">
            <h5><i class="fas fa-tasks me-2"></i>Pending for Review (<span id="tlCount">0</span>)</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tlTable">
                    <thead class="table-primary">
                        <tr>
                            <th>CRF ID</th>
                            <th>CRF Name</th>
                            <th>Release Date</th>
                            <th>Tester</th>
                            <th>Status</th>
                            <th>Tester Remarks</th>
                            <th>Attachment</th>
                            <th>TL Remarks *</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tlBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('tlFilterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const from = document.getElementById('tlFromDate').value;
            const to = document.getElementById('tlToDate').value;

            if (!from || !to) return alert('Select both dates');

            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const res = await fetch(`/api/qa/release?fromDate=${from}&toDate=${to}&pageval=pending_tl`);
                const data = await res.json();

                renderTLTable(data);
                document.getElementById('tlCard').style.display = 'block';
                document.getElementById('tlCount').textContent = data.length;
            } catch (err) {
                alert('Error loading data');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search me-2"></i>Load Pending';
            }
        });

        function renderTLTable(data) {
            const tbody = document.getElementById('tlBody');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                            <td>${item.CRF_ID}</td>
                            <td>${item.SUBJECT}</td>
                            <td>${item.RELEASE_DATE}</td>
                            <td>${item.TESTER_NAMES}</td>
                            <td><span class="badge bg-info">${item.CURRENT_STATUS}</span></td>
                            <td>${item.REMARKS || '-'}</td>
                            <td>
                                ${item.ATTACHMENT_NAME ?
                        `<a href="/api/qa/blob/${item.SEQ_RR}" target="_blank">View</a>` : '-'}
                            </td>
                            <td><textarea class="form-control tl-remarks" rows="2"></textarea></td>
                            <td>
                                <button class="btn btn-sm btn-success confirm-tl">Confirm</button>
                                <button class="btn btn-sm btn-warning return-tl">Return</button>
                            </td>
                        `;
                tbody.appendChild(row);

                row.querySelector('.confirm-tl').onclick = () => tlAction(item.SEQ_RR, 'confirm', row);
                row.querySelector('.return-tl').onclick = () => tlAction(item.SEQ_RR, 'return', row);
            });
        }

        async function tlAction(seqRr, action, row) {
            const remarks = row.querySelector('.tl-remarks').value.trim();
            if (action === 'confirm' && !remarks) return alert('Remarks required for Confirm');

            if (!confirm(`Are you sure to ${action === 'confirm' ? 'CONFIRM' : 'RETURN'}?`)) return;

            try {
                const res = await fetch(`/api/qa/release`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pageval: 'tl_action',
                        parval1: seqRr,
                        parval2: action,
                        parval3: remarks
                    })
                });

                if (res.ok) {
                    alert(`CRF ${action === 'confirm' ? 'confirmed' : 'returned'} successfully`);
                    document.getElementById('tlFilterForm').dispatchEvent(new Event('submit'));
                } else {
                    alert('Action failed');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
}