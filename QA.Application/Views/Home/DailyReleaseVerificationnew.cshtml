@{
    ViewData["Title"] = "Daily Release Verification - Tester";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

@{
    string currentUserName = "Unknown";
    try
    {
        var token = Context.Request.Cookies["jwtToken"] ??
                    Context.Request.Headers["Authorization"].ToString().Replace("Bearer ", "");
        if (!string.IsNullOrEmpty(token))
        {
            var handler = new System.IdentityModel.Tokens.Jwt.JwtSecurityTokenHandler();
            var jwtToken = handler.ReadJwtToken(token);
            currentUserName = jwtToken.Claims.FirstOrDefault(c =>
                c.Type == "given_name" || c.Type == "name" || c.Type == "unique_name")?.Value ?? "Unknown";
        }
    }
    catch { }

    var techLeads = new[] { "JIJIN E H", "MURUGESAN P", "NIKHIL SEKHAR", "SMINA BENNY", "VISAGH S", "JOBY JOSE" };
    bool isTechLead = techLeads.Contains(currentUserName.Trim(), StringComparer.OrdinalIgnoreCase);
}

@if (isTechLead)
{
    <div class="container-fluid mt-5">
        <div class="alert alert-warning text-center py-5 shadow">
            <h4><i class="fas fa-lock me-2"></i>Access Restricted</h4>
            <p>This page is for testers only.</p>
            <a href="@Url.Action("DailyVerificationTL", "Home")" class="btn btn-primary mt-3">
                <i class="fas fa-arrow-right me-2"></i> Go to Tech Lead Page
            </a>
        </div>
    </div>
}
else
{
    <div class="container-fluid mt-4 px-3 px-md-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-primary">
                <i class="fas fa-calendar-check me-2"></i>Daily Release Verification
            </h3>
            <span class="badge bg-light text-dark px-3 py-2">
                Tester: <strong>@currentUserName</strong>
            </span>
        </div>

        <!-- Filters -->
        <div class="card shadow border-0 mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Releases</h6>
            </div>
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Release Type *</label>
                        <select class="form-select" id="releaseType" required>
                            <option value="">-- Select --</option>
                            <option value="1">Normal Release</option>
                            <option value="2">Exception Release</option>
                            <option value="3">Expedite Release</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">From Date *</label>
                        <input type="date" class="form-control" id="fromDate" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">To Date *</label>
                        <input type="date" class="form-control" id="toDate" required />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" id="loadBtn">
                            <i class="fas fa-search me-2"></i>Load
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card shadow border-0" id="resultCard" style="display:none;">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>CRFs to Verify
                    <span class="badge bg-primary ms-2" id="totalCount">0</span>
                </h5>
                <button class="btn btn-outline-secondary btn-sm" id="exportBtn">
                    <i class="fas fa-file-excel me-1"></i>Export
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-bordered mb-0" id="verificationTable">
                        <thead class="table-primary">
                            <tr>
                                <th>CRF ID</th>
                                <th>Req ID</th>
                                <th>CRF Name</th>
                                <th>Release Date</th>
                                <th>Tech Lead</th>
                                <th>Developer</th>
                                <th>Tester TL</th>
                                <th>Tester</th>
                                <th>Status *</th>
                                <th>Remarks *</th>
                                <th>Attachment</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div id="noData" class="text-center py-5 text-muted d-none">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <h5>No records found</h5>
                    <p>Adjust filters and try again</p>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">History for CRF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-sm table-bordered" id="historyTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>By</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const API_BASE = window.location.origin + '/api/DailyVerification';

        // Status options
        const STATUS_OPTS = [
            { v: "1", t: "Working" },
            { v: "2", t: "Not Working" },
            { v: "3", t: "In Progress" },
            { v: "4", t: "Data Need" },
            { v: "5", t: "User Feedback Pending" },
            { v: "6", t: "Hold" }
        ];

        // Default dates: last 7 days
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            document.getElementById('toDate').valueAsDate = today;
            document.getElementById('fromDate').valueAsDate = weekAgo;
        });

        // Load CRFs
        document.getElementById('filterForm').addEventListener('submit', async e => {
            e.preventDefault();

            const type = document.getElementById('releaseType').value;
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;

            if (!type || !from || !to) return alert('Fill all fields');

            const btn = document.getElementById('loadBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const params = new URLSearchParams({ fromDate: from, toDate: to, releaseType: type });
                const res = await fetch(`${API_BASE}?${params}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!res.ok) throw new Error(await res.text());

                const data = await res.json();

                renderTable(data);
                document.getElementById('resultCard').style.display = 'block';
                document.getElementById('totalCount').textContent = data.length;
            } catch (err) {
                alert('Failed to load: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search me-2"></i> Load';
            }
        });

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('noData').classList.remove('d-none');
                return;
            }

            document.getElementById('noData').classList.add('d-none');

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                            <td class="fw-bold">${item.CRF_ID}</td>
                            <td>${item.REQUEST_ID || '-'}</td>
                            <td>${item.SUBJECT || '-'}</td>
                            <td>${item.RELEASE_DATE || '-'}</td>
                            <td>${item.TECHLEAD_NAME || '-'}</td>
                            <td>${item.DEVELOPER_NAMES || '-'}</td>
                            <td>${item.TESTER_TL_NAME || '-'}</td>
                            <td>${item.TESTER_NAMES || '-'}</td>
                            <td><select class="form-select status-select">${STATUS_OPTS.map(o => `<option value="${o.v}">${o.t}</option>`).join('')}</select></td>
                            <td><textarea class="form-control remarks" rows="2"></textarea></td>
                            <td><input type="file" class="form-control file-input" accept=".pdf,.jpg,.png,.docx"/></td>
                            <td>
                                <button class="btn btn-sm btn-success save-btn">Save</button>
                                <button class="btn btn-sm btn-info mt-1 history-btn">History</button>
                            </td>
                        `;
                tbody.appendChild(tr);

                tr.querySelector('.save-btn').onclick = () => saveItem(item, tr);
                tr.querySelector('.history-btn').onclick = () => loadHistory(item.CRF_ID, item.REQUEST_ID);
            });
        }

        async function saveItem(item, row) {
            const status = row.querySelector('.status-select').value;
            const remarks = row.querySelector('.remarks').value.trim();

            if (!status) return alert('Select status');
            if (!remarks) return alert('Enter remarks');

            const file = row.querySelector('.file-input').files[0];

            const formData = new FormData();
            formData.append('crfId', item.CRF_ID);
            formData.append('requestId', item.REQUEST_ID || '0');
            formData.append('workingStatus', status);
            formData.append('remarks', remarks);
            if (file) formData.append('attachment', file);

            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (res.ok) {
                    alert('Saved!');
                    document.getElementById('filterForm').dispatchEvent(new Event('submit'));
                } else {
                    alert('Save failed: ' + await res.text());
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function loadHistory(crfId, reqId) {
            const res = await fetch(`${API_BASE}/history?crfId=${crfId}&requestId=${reqId || '0'}`, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            const data = await res.json();

            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = data.map(h => `
                        <tr>
                            <td>${h.updated_date}</td>
                            <td>${h.working_status}</td>
                            <td>${h.remarks || '-'}</td>
                            <td>${h.updated_by_name || '-'}</td>
                        </tr>
                    `).join('');

            new bootstrap.Modal('#historyModal').show();
        }

        function getToken() {
            return document.cookie.match(/jwtToken=([^;]+)/)?.[1] || '';
        }
    </script>
}