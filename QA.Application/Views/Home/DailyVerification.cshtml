@{
    ViewData["Title"] = "Daily Release Verification";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid mt-4 px-2 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 text-primary fw-bold">Daily Release Verification</h3>
        <span class="text-muted small">Verify released CRFs daily</span>
    </div>

    <!-- Filters Card -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-gradient bg-primary text-white">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Search Filters</h6>
        </div>
        <div class="card-body">
            <form id="filterForm" novalidate>
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">Release Type <span class="text-danger">*</span></label>
                        <select class="form-select form-select-lg" id="releaseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="Daily Release Report">Daily Release Report</option>
                            <option value="Exceptional & Expedite Report">Exceptional & Expedite</option>
                        </select>
                        <div class="invalid-feedback">Please select release type</div>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="fromDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="toDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-lg-2 col-md-12 d-grid">
                        <label class="form-label fw-semibold opacity-0">Action</label>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table Card -->
    <div class="card shadow border-0" id="resultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Verification List</h5>
            <div class="d-flex flex-column flex-md-row gap-3 align-items-md-center">
                <small class="text-light opacity-90">
                    <i class="fas fa-info-circle me-1"></i>
                    Select Status + Add Remarks → Click <strong>Confirm</strong>
                </small>
                <div class="text-light">
                    <strong>Total Records: <span id="totalRecords">0</span></strong>
                </div>
                <button type="button" class="btn btn-light btn-sm" id="exportExcelBtn">
                    <i class="fas fa-file-excel me-1"></i>Export to Excel
                </button>
            </div>
        </div>
        <div class="card-header border-bottom bg-light px-4 py-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="tableSearch"
                           placeholder="Search by CRF ID or CRF Name..." />
                </div>
                <div class="col-md-6 d-flex justify-content-end align-items-center gap-3">
                    <nav aria-label="Table pagination">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item"><a class="page-link" href="#" id="prevPage">Previous</a></li>
                            <li class="page-item"><a class="page-link" href="#" id="nextPage">Next</a></li>
                        </ul>
                    </nav>
                    <span class="text-muted small">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" id="verificationTable">
                    <thead class="table-primary sticky-top shadow-sm" style="z-index: 10;">
                        <tr>
                            <th class="ps-4">CRF ID</th>
                            <th>Request ID</th>
                            <th>Type</th>
                            <th style="min-width:200px;">CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester TL</th>
                            <th>Tester</th>
                            <th class="text-center" style="min-width:160px;">Status <span class="text-danger">*</span></th>
                            <th style="min-width:250px;">Remarks <span class="text-danger">*</span></th>
                            <th style="min-width:150px;">Attachment</th>
                            <th class="text-center" style="min-width:120px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verificationBody" class="bg-white"></tbody>
                </table>
            </div>
            <div class="text-center py-5 text-muted" id="emptyState" style="display:none;">
                <i class="fas fa-search fa-3x mb-4 text-muted opacity-50"></i>
                <h4 class="text-muted">No Records Found</h4>
                <p class="lead">No verifications match your selected filters.</p>
                <p>Try adjusting the date range or release type.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const API_BASE = 'https://localhost:7118/api/Verification';

        const STATUS_OPTIONS = [
            { value: 1, text: "Working" },
            { value: 2, text: "Not Working" },
            { value: 3, text: "In Progress" },
            { value: 4, text: "User Feedback Pending" },
            { value: 5, text: "Data Need to Capture" },
            { value: 6, text: "Hold" }
        ];

        const STATUS_MAP = {
            0: "Pending",
            1: "Working",
            2: "Not Working",
            3: "In Progress",
            4: "User Feedback Pending",
            5: "Data Need to Capture",
            6: "Hold"
        };

        const VERIFY_STATUS_MAP = {
            0: "Not Verified",
            1: "Tester Verified",
            2: "TL Approved",
            3: "TL Returned",
            4: "Updated on Return"
        };

        let verificationData = [];
        let filteredData = [];
        const pageSize = 10;
        let currentPage = 1;

        function formatDateForOracle(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            return `${String(d.getDate()).padStart(2, '0')}-${months[d.getMonth()]}-${d.getFullYear()}`;
        }

        function showToast(message, type = "success") {
            const toast = document.createElement("div");
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
            toast.style.zIndex = 9999;
            toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>`;
            document.body.appendChild(toast);
            new bootstrap.Toast(toast).show();
            setTimeout(() => toast.remove(), 5000);
        }

        document.getElementById("filterForm").addEventListener("submit", async e => {
            e.preventDefault();

            const fromDateInput = document.getElementById("fromDate");
            const toDateInput = document.getElementById("toDate");
            const releaseTypeSelect = document.getElementById("releaseType");

            let valid = true;
            [fromDateInput, toDateInput, releaseTypeSelect].forEach(el => {
                if (!el.value.trim()) {
                    el.classList.add("is-invalid");
                    valid = false;
                } else {
                    el.classList.remove("is-invalid");
                }
            });

            if (new Date(fromDateInput.value) > new Date(toDateInput.value)) {
                toDateInput.classList.add("is-invalid");
                showToast("From Date cannot be greater than To Date", "danger");
                return;
            }

            if (!valid) return;

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Searching...';

            try {
                const url = new URL(`${API_BASE}/tester`);
                url.searchParams.append('fromDate', formatDateForOracle(fromDateInput.value));
                url.searchParams.append('toDate', formatDateForOracle(toDateInput.value));
                if (releaseTypeSelect.value) {
                    url.searchParams.append('releaseType', releaseTypeSelect.value);
                }

                const res = await fetch(url, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Authorization': 'Bearer ' + (document.cookie.match(/jwtToken=([^;]+)/) || [])[1]
                    }
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`Server error ${res.status}: ${errText}`);
                }

                const rawData = await res.json();

                if (!Array.isArray(rawData) || rawData.length === 0) {
                    showToast("No records found for selected filters.", "info");
                    verificationData = filteredData = [];
                    document.getElementById("resultCard").style.display = "none";
                    document.getElementById("emptyState").style.display = "block";
                    return;
                }

                verificationData = rawData.map(item => ({
                    crfId: item.crfId || "N/A",
                    requestId: item.requestId || "",
                    crfName: item.crfName || "Unknown CRF",
                    releaseDate: item.releaseDate || "",
                    releaseType: item.releaseType || "",
                    techLeadName: item.techLeadName || "Not Assigned",
                    developerName: item.developerName || "Not Assigned",
                    testerTlName: item.testerTlName || "Not Assigned",
                    testerName: item.testerName || "Not Assigned",
                    workingStatus: item.workingStatus || 0,
                    remarks: item.remarks || "",
                    tlRemarks: item.tlRemarks || "",
                    attachmentName: item.attachmentName || "",
                    verifiedBy: item.verifiedBy || "",
                    verifiedOn: item.verifiedOn || "",
                    verifyStatus: item.verifyStatus || 0,
                    isConfirmed: item.verifyStatus === 2,
                    isReturned: item.verifyStatus === 3,
                    isEditable: [0, 1, 3, 4].includes(item.verifyStatus)
                }));

                filteredData = [...verificationData];
                currentPage = 1;
                updateTableAndPagination();
                document.getElementById("resultCard").style.display = "block";
                document.getElementById("emptyState").style.display = "none";

            } catch (err) {
                console.error("Search error:", err);
                showToast("Failed to load data: " + err.message, "danger");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-search me-2"></i>Search';
            }
        });

        function updateTableAndPagination() {
            document.getElementById("totalRecords").textContent = filteredData.length;
            const totalPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
            document.getElementById("totalPages").textContent = totalPages;
            document.getElementById("currentPage").textContent = currentPage;
            document.getElementById("prevPage").parentElement.classList.toggle("disabled", currentPage === 1);
            document.getElementById("nextPage").parentElement.classList.toggle("disabled", currentPage === totalPages);
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById("verificationBody");
            tbody.innerHTML = "";
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredData.slice(start, end);

            if (filteredData.length === 0) {
                document.getElementById("emptyState").style.display = "block";
                return;
            }
            document.getElementById("emptyState").style.display = "none";

            pageData.forEach((item, idx) => {
                const globalIdx = filteredData.indexOf(item);
                const isDaily = item.releaseType.includes("Daily");
                const badgeCls = isDaily ? "bg-primary" : "bg-warning text-dark";
                const badgeText = isDaily ? "Daily" : "Exp.";
                const canConfirm = item.workingStatus > 0 && (item.remarks || "").trim().length > 0;
                const statusBadge = VERIFY_STATUS_MAP[item.verifyStatus] || "Unknown";
                const statusColor = item.verifyStatus === 2 ? "success" :
                    item.verifyStatus === 3 ? "warning" : "secondary";

                const row = document.createElement("tr");
                row.innerHTML = `
                        <td class="ps-4">
                            <strong class="text-primary">${item.crfId}</strong>
                            <br><small class="badge bg-${statusColor}">${statusBadge}</small>
                        </td>
                        <td><span class="badge bg-secondary fs-7">${item.requestId || 'N/A'}</span></td>
                        <td><span class="badge ${badgeCls} fs-7">${badgeText}</span></td>
                        <td class="text-wrap" title="${item.crfName}">
                            ${item.crfName.length > 50 ? item.crfName.substring(0, 47) + '...' : item.crfName}
                        </td>
                        <td>${item.releaseDate}</td>
                        <td><strong>${item.techLeadName}</strong></td>
                        <td>${item.developerName}</td>
                        <td><strong>${item.testerTlName}</strong></td>
                        <td>${item.testerName}</td>
                        <td class="text-center align-middle">
                            ${item.isConfirmed || !item.isEditable
                        ? `<span class="badge bg-success px-3 py-2">${STATUS_MAP[item.workingStatus]}</span>`
                        : `<select class="form-select form-select-sm status-select" data-idx="${globalIdx}">
                                      <option value="0">-- Select --</option>
                                      ${STATUS_OPTIONS.map(opt =>
                            `<option value="${opt.value}" ${item.workingStatus === opt.value ? 'selected' : ''}>${opt.text}</option>`
                        ).join('')}
                                   </select>`
                    }
                        </td>
                        <td class="align-middle">
                            ${item.tlRemarks ? `
                                <div class="alert alert-warning small py-2 mb-2 border-start border-warning border-4" role="alert">
                                    <strong class="d-block mb-1">
                                        <i class="fas fa-exclamation-triangle me-1"></i> TL Remarks:
                                    </strong>
                                    <div class="ms-2">${item.tlRemarks.replace(/\n/g, '<br>')}</div>
                                </div>
                            ` : ''}
                            <textarea class="form-control form-control-sm remarks-text w-100" rows="3" data-idx="${globalIdx}"
                                ${!item.isEditable ? 'readonly' : ''}
                                placeholder="${item.isEditable ? 'Enter your remarks here...' : ''}">${item.remarks || ''}</textarea>
                            ${item.tlRemarks && item.isEditable ? `
                                <small class="text-danger d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i> Please address TL remarks and resubmit.
                                </small>
                            ` : ''}
                            <small class="text-muted d-block mt-1 word-count" data-idx="${globalIdx}">
                                ${(item.remarks || '').trim().split(/\s+/).filter(w => w.length > 0).length} words
                            </small>
                        </td>
                        <td class="align-middle text-center">
                            ${item.isEditable && !item.isConfirmed
                        ? `<input type="file" class="form-control form-control-sm file-input" data-idx="${globalIdx}"
                                          accept=".pdf,.jpg,.jpeg,.png,.doc,.docx">`
                        : (item.attachmentName
                            ? `<a href="${API_BASE}/Attachment/${encodeURIComponent(item.crfId)}/${encodeURIComponent(item.releaseDate)}"
                                          target="_blank" class="btn btn-sm btn-outline-primary">
                                          <i class="fas fa-paperclip me-1"></i> ${item.attachmentName}
                                       </a>`
                            : '<span class="text-muted">-</span>')
                    }
                        </td>
                        <td class="text-center align-middle">
                            ${item.isEditable && !item.isConfirmed
                        ? `<button class="btn ${canConfirm ? 'btn-primary' : 'btn-secondary'} btn-sm px-3 confirm-btn"
                                           data-idx="${globalIdx}" ${!canConfirm ? 'disabled' : ''}>
                                       <i class="fas fa-check me-1"></i>Confirm
                                   </button>`
                        : `<button class="btn btn-success btn-sm px-3" disabled>
                                       <i class="fas fa-check-circle me-1"></i>Confirmed
                                   </button>`
                    }
                        </td>
                    `;
                tbody.appendChild(row);
            });

            attachEvents();
        }

        function attachEvents() {
            document.querySelectorAll(".status-select").forEach(sel => {
                sel.addEventListener("change", e => {
                    const idx = e.target.dataset.idx;
                    verificationData[idx].workingStatus = parseInt(e.target.value);
                    updateConfirmButton(idx);
                });
            });

            document.querySelectorAll(".remarks-text").forEach(ta => {
                ta.addEventListener("input", e => {
                    const idx = e.target.dataset.idx;
                    verificationData[idx].remarks = e.target.value;
                    const words = e.target.value.trim().split(/\s+/).filter(w => w.length > 0).length;
                    const wordCountEl = ta.parentElement.querySelector(".word-count");
                    if (wordCountEl) wordCountEl.textContent = words + " words";
                    updateConfirmButton(idx);
                });
            });

            document.querySelectorAll(".confirm-btn").forEach(btn => {
                btn.addEventListener("click", e => {
                    const idx = e.target.dataset.idx;
                    saveItem(verificationData[idx]);
                });
            });
        }

        function updateConfirmButton(idx) {
            const item = verificationData[idx];
            const canConfirm = item.workingStatus > 0 && (item.remarks || "").trim().length > 0;
            const btn = document.querySelector(`.confirm-btn[data-idx="${idx}"]`);
            if (btn) {
                btn.disabled = !canConfirm;
                btn.className = `btn btn-sm px-3 confirm-btn ${canConfirm ? 'btn-primary' : 'btn-secondary'}`;
            }
        }

        async function saveItem(item) {
            if (!item.workingStatus || item.workingStatus === 0) {
                showToast("Please select a Status", "danger");
                return;
            }
            if (!item.remarks?.trim()) {
                showToast("Remarks are mandatory", "danger");
                return;
            }

            const fileInput = document.querySelector(`.file-input[data-idx="${verificationData.indexOf(item)}"]`);
            const file = fileInput?.files[0];
            let attachmentBase64 = null, attachmentName = null, attachmentMime = null;

            if (file) {
                attachmentBase64 = await fileToBase64(file);
                attachmentName = file.name;
                attachmentMime = file.type;
            }

            const payload = [{
                crfId: item.crfId,
                requestId: item.requestId || null,
                workingStatus: parseInt(item.workingStatus),
                remarks: item.remarks.trim(),
                attachmentName: attachmentName || item.attachmentName || null,
                attachmentBase64: attachmentBase64,
                attachmentMime: attachmentMime
            }];

            try {
                const res = await fetch(`${API_BASE}/testersave`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (document.cookie.match(/jwtToken=([^;]+)/) || [])[1]
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    showToast("✓ Verification saved successfully!", "success");
                    document.getElementById("filterForm").dispatchEvent(new Event('submit'));
                } else {
                    const error = await res.json();
                    showToast("Save failed: " + (error.error || error.details), "danger");
                }
            } catch (err) {
                showToast("Error: " + err.message, "danger");
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        document.getElementById("prevPage").addEventListener("click", e => {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                updateTableAndPagination();
            }
        });

        document.getElementById("nextPage").addEventListener("click", e => {
            e.preventDefault();
            if (currentPage < Math.ceil(filteredData.length / pageSize)) {
                currentPage++;
                updateTableAndPagination();
            }
        });

        document.getElementById("tableSearch").addEventListener("input", e => {
            const query = e.target.value.toLowerCase();
            filteredData = verificationData.filter(item =>
                item.crfId.toLowerCase().includes(query) ||
                item.crfName.toLowerCase().includes(query)
            );
            currentPage = 1;
            updateTableAndPagination();
        });

        document.getElementById("exportExcelBtn").addEventListener("click", () => {
            if (filteredData.length === 0) {
                alert("No data to export!");
                return;
            }

            const dataToExport = filteredData.map(item => ({
                "CRF ID": item.crfId,
                "Request ID": item.requestId || "N/A",
                "Type": item.releaseType.includes("Daily") ? "Daily" : "Exp.",
                "CRF Name": item.crfName,
                "Release Date": item.releaseDate,
                "Tech Lead": item.techLeadName,
                "Developer": item.developerName,
                "Tester TL": item.testerTlName,
                "Tester": item.testerName,
                "Status": STATUS_MAP[item.workingStatus] || "Pending",
                "Remarks": (item.remarks || "").replace(/\n/g, " "),
                "Verified Status": VERIFY_STATUS_MAP[item.verifyStatus],
                "Verified By": item.verifiedBy || "-",
                "Verified On": item.verifiedOn || "-"
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Verification Data");

            ws['!cols'] = [
                { wch: 12 }, { wch: 15 }, { wch: 8 }, { wch: 50 },
                { wch: 15 }, { wch: 20 }, { wch: 25 }, { wch: 20 },
                { wch: 25 }, { wch: 20 }, { wch: 50 }, { wch: 20 },
                { wch: 20 }, { wch: 20 }
            ];

            XLSX.writeFile(wb, `Daily_Release_Verification_${new Date().toISOString().slice(0, 10)}.xlsx`);
        });

        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            document.getElementById('toDate').valueAsDate = today;
            document.getElementById('fromDate').valueAsDate = yesterday;
        });
    </script>
}