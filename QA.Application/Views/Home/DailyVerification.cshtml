@{
    ViewData["Title"] = "Daily Release Verification";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid mt-4 px-2 px-md-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0 text-primary fw-bold">Daily Release Verification</h3>
        <span class="text-muted small">Verify released CRFs daily</span>
    </div>

    <!-- Filters Card -->
    <div class="card shadow border-0 mb-4">
        <div class="card-header bg-gradient bg-primary text-white">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Search Filters</h6>
        </div>
        <div class="card-body">
            <form id="filterForm" novalidate>
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-semibold">Release Type <span class="text-danger">*</span></label>
                        <select class="form-select form-select-lg" id="releaseType" required>
                            <option value="">-- Select Type --</option>
                            <option value="Daily Release Report">Daily Release Report</option>
                            <option value="Exceptional & Expedite Report">Exceptional & Expedite</option>
                        </select>
                        <div class="invalid-feedback">Please select release type</div>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">From Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="fromDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label class="form-label fw-semibold">To Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control form-control-lg" id="toDate" required />
                        <div class="invalid-feedback">Required</div>
                    </div>
                    <div class="col-lg-2 col-md-12 d-grid">
                        <label class="form-label fw-semibold opacity-0">Action</label>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-2"></i>Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table Card -->
    <div class="card shadow border-0" id="resultCard" style="display:none;">
        <div class="card-header bg-primary text-white d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Verification List</h5>
            <div class="d-flex flex-column flex-md-row gap-3 align-items-md-center">
                <small class="text-light opacity-90">
                    <i class="fas fa-info-circle me-1"></i>
                    Select Status + Add Remarks → Click <strong>Confirm</strong>
                </small>
                <div class="text-light">
                    <strong>Total Records: <span id="totalRecords">0</span></strong>
                </div>
                <button type="button" class="btn btn-light btn-sm" id="exportExcelBtn">
                    <i class="fas fa-file-excel me-1"></i>Export to Excel
                </button>
            </div>
        </div>
        <div class="card-header border-bottom bg-light px-4 py-3">
            <div class="row g-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="tableSearch"
                           placeholder="Search by CRF ID or CRF Name..." />
                </div>
                <div class="col-md-6 d-flex justify-content-end align-items-center gap-3">
                    <nav aria-label="Table pagination">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item"><a class="page-link" href="#" id="prevPage">Previous</a></li>
                            <li class="page-item"><a class="page-link" href="#" id="nextPage">Next</a></li>
                        </ul>
                    </nav>
                    <span class="text-muted small">
                        Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle" id="verificationTable">
                    <thead class="table-primary sticky-top shadow-sm" style="z-index: 10;">
                        <tr>
                            <th class="ps-4">CRF ID</th>
                            <th>Request ID</th>
                            <th>Type</th>
                            <th style="min-width:200px;">CRF Name</th>
                            <th>Release Date</th>
                            <th>Tech Lead</th>
                            <th>Developer</th>
                            <th>Tester TL</th>
                            <th>Tester</th>
                            <th class="text-center" style="min-width:160px;">Status <span class="text-danger">*</span></th>
                            <th style="min-width:250px;">Remarks <span class="text-danger">*</span></th>
                            <th style="min-width:150px;">Attachment</th>
                            <th class="text-center" style="min-width:120px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="verificationBody" class="bg-white"></tbody>
                </table>
            </div>
            <div class="text-center py-5 text-muted" id="emptyState" style="display:none;">
                <i class="fas fa-search fa-3x mb-4 text-muted opacity-50"></i>
                <h4 class="text-muted">No Records Found</h4>
                <p class="lead">No verifications match your selected filters.</p>
                <p>Try adjusting the date range or release type.</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // ============================================================================
        // DAILY VERIFICATION - FRONTEND JAVASCRIPT (TESTER VIEW)
        // ============================================================================

        const API_BASE = window.location.origin + '/api/DailyVerification';

        // Status options matching your working_status column
        const STATUS_OPTS = [
            { v: "1", t: "Working" },
            { v: "2", t: "Not Working" },
            { v: "3", t: "In Progress" },
            { v: "4", t: "Data Need" },
            { v: "5", t: "User Feedback Pending" },
            { v: "6", t: "Hold" }
        ];

        // Default dates: yesterday to today
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            document.getElementById('toDate').valueAsDate = today;
            document.getElementById('fromDate').valueAsDate = yesterday;
        });

        // Form submit - Load CRFs
        document.getElementById('filterForm').addEventListener('submit', async e => {
            e.preventDefault();

            const type = document.getElementById('releaseType').value || '0';
            const from = document.getElementById('fromDate').value;
            const to = document.getElementById('toDate').value;

            if (!from || !to) {
                alert('Please select both dates');
                return;
            }

            // CRITICAL: Convert to DD-MM-YYYY format for Oracle
            const fromOracle = formatDateForOracle(from);
            const toOracle = formatDateForOracle(to);

            console.log('Sending:', { fromDate: fromOracle, toDate: toOracle, releaseType: type });

            const btn = document.getElementById('loadBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';

            try {
                const params = new URLSearchParams({
                    fromDate: fromOracle,
                    toDate: toOracle,
                    releaseType: type
                });

                const res = await fetch(`${API_BASE}?${params}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`,
                        'Accept': 'application/json'
                    }
                });

                console.log('Response status:', res.status);

                if (!res.ok) {
                    const errText = await res.text();
                    console.error('Error response:', errText);
                    throw new Error(`Server error ${res.status}: ${errText}`);
                }

                const data = await res.json();
                console.log('Received data:', data);

                renderTable(data);
                document.getElementById('resultCard').style.display = 'block';
                document.getElementById('totalCount').textContent = data.length;
            } catch (err) {
                console.error('Fetch failed:', err);
                alert('Failed to load data: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search me-2"></i> Load';
            }
        });

        // Convert input date (YYYY-MM-DD) to Oracle format (DD-MM-YYYY)
        function formatDateForOracle(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${day}-${month}-${year}`;
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                document.getElementById('noData').classList.remove('d-none');
                return;
            }

            document.getElementById('noData').classList.add('d-none');

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-bold text-primary">${item.CRF_ID || '-'}</td>
                    <td>${item.REQUEST_ID || '-'}</td>
                    <td class="text-wrap" title="${item.SUBJECT || ''}">
                        ${item.SUBJECT?.substring(0, 60) || 'N/A'}${item.SUBJECT?.length > 60 ? '...' : ''}
                    </td>
                    <td>${item.RELEASE_DATE || '-'}</td>
                    <td>${item.TECHLEAD_NAME || '-'}</td>
                    <td>${item.DEVELOPER_NAMES || '-'}</td>
                    <td>${item.TESTER_TL_NAME || '-'}</td>
                    <td>${item.TESTER_NAMES || '-'}</td>
                    <td>
                        <select class="form-select form-select-sm status-select" required>
                            <option value="">-- Select --</option>
                            ${STATUS_OPTS.map(o => `<option value="${o.v}">${o.t}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <textarea class="form-control form-control-sm remarks" rows="2"
                                  placeholder="Enter remarks..." required></textarea>
                    </td>
                    <td>
                        <input type="file" class="form-control form-control-sm file-input"
                               accept=".pdf,.jpg,.jpeg,.png,.docx"/>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-success save-btn mb-1">
                            <i class="fas fa-save me-1"></i>Submit
                        </button>
                        <button class="btn btn-sm btn-info history-btn">
                            <i class="fas fa-history me-1"></i>History
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Bind events
                tr.querySelector('.save-btn').onclick = () => saveItem(item, tr);
                tr.querySelector('.history-btn').onclick = () => loadHistory(item.CRF_ID, item.REQUEST_ID || '0');
            });
        }

        async function saveItem(item, row) {
            const status = row.querySelector('.status-select').value;
            const remarks = row.querySelector('.remarks').value.trim();
            const fileInput = row.querySelector('.file-input');

            // Validation
            if (!status) {
                alert('Please select working status');
                return;
            }
            if (!remarks) {
                alert('Remarks are required');
                return;
            }

            // Confirm submission
            if (!confirm(`Submit verification for CRF ${item.CRF_ID}?`)) {
                return;
            }

            const formData = new FormData();
            formData.append('crfId', item.CRF_ID || '0');
            formData.append('requestId', item.REQUEST_ID || '0');
            formData.append('workingStatus', status);
            formData.append('remarks', remarks);

            if (fileInput.files[0]) {
                formData.append('attachment', fileInput.files[0]);
            }

            const saveBtn = row.querySelector('.save-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${getToken()}`
                    }
                });

                if (res.ok) {
                    alert('✅ Verification submitted successfully!');
                    // Refresh the list
                    document.getElementById('filterForm').dispatchEvent(new Event('submit'));
                } else {
                    const err = await res.text();
                    alert('❌ Save failed: ' + err);
                }
            } catch (err) {
                alert('❌ Error: ' + err.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>Submit';
            }
        }

        async function loadHistory(crfId, reqId) {
            try {
                const res = await fetch(
                    `${API_BASE}/history?crfId=${encodeURIComponent(crfId)}&requestId=${encodeURIComponent(reqId)}`,
                    {
                        credentials: 'include',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`,
                            'Accept': 'application/json'
                        }
                    }
                );

                if (!res.ok) throw new Error(await res.text());

                const data = await res.json();
                const tbody = document.querySelector('#historyTable tbody');

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No history found</td></tr>';
                } else {
                    tbody.innerHTML = data.map(h => `
                        <tr>
                            <td>${h.UPDATED_DATE || h.updated_date || '-'}</td>
                            <td>
                                <span class="badge ${getStatusBadge(h.WORKING_STATUS || h.working_status)}">
                                    ${getStatusText(h.WORKING_STATUS || h.working_status)}
                                </span>
                            </td>
                            <td>${h.REMARKS || h.remarks || '-'}</td>
                            <td>${h.UPDATED_BY_NAME || h.updated_by_name || '-'}</td>
                        </tr>
                    `).join('');
                }

                new bootstrap.Modal(document.getElementById('historyModal')).show();
            } catch (err) {
                alert('Failed to load history: ' + err.message);
            }
        }

        function getStatusText(status) {
            const opt = STATUS_OPTS.find(o => o.v == status);
            return opt ? opt.t : 'Unknown';
        }

        function getStatusBadge(status) {
            const badges = {
                '1': 'bg-success',
                '2': 'bg-danger',
                '3': 'bg-warning',
                '4': 'bg-info',
                '5': 'bg-secondary',
                '6': 'bg-dark'
            };
            return badges[status] || 'bg-secondary';
        }

        function getToken() {
            const match = document.cookie.match(/jwtToken=([^;]+)/);
            return match ? match[1] : '';
        }

        // Export to Excel
        document.getElementById('exportBtn')?.addEventListener('click', () => {
            const table = document.getElementById('verificationTable');
            const wb = XLSX.utils.table_to_book(table, { sheet: "Verifications" });
            XLSX.writeFile(wb, `QA_Verifications_${new Date().toISOString().split('T')[0]}.xlsx`);
        });


        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            document.getElementById('toDate').valueAsDate = today;
            document.getElementById('fromDate').valueAsDate = yesterday;
        });
    </script>
}